// Copyright 2018 gopcua authors. All rights reserved.
// Use of this source code is governed by a MIT-style license that can be
// found in the LICENSE file.

package datatypes

import (
	"testing"

	"github.com/google/go-cmp/cmp"
)

var endpointDescriptionCases = []struct {
	description string
	structured  *EndpointDescription
	serialized  []byte
}{
	{
		"normal",
		NewEndpointDescription(
			"ep-url",
			NewApplicationDescription(
				"app-uri", "prod-uri", "app-name", AppTypeServer,
				"gw-uri", "prof-uri", []string{"discov-uri-1", "discov-uri-2"},
			),
			[]byte{},
			1,
			"sec-uri",
			NewUserTokenPolicyArray(
				[]*UserTokenPolicy{
					NewUserTokenPolicy(
						"1", UserTokenAnonymous,
						"issued-token", "issuer-uri", "sec-uri",
					),
					NewUserTokenPolicy(
						"1", UserTokenAnonymous,
						"issued-token", "issuer-uri", "sec-uri",
					),
				},
			),
			"trans-uri",
			0,
		),
		[]byte{
			// EndpointURI
			0x06, 0x00, 0x00, 0x00, 0x65, 0x70, 0x2d, 0x75, 0x72, 0x6c,
			// Server (ApplicationDescription)
			// ApplicationURI
			0x07, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d, 0x75, 0x72, 0x69,
			// ProductURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x64, 0x2d, 0x75, 0x72, 0x69,
			// ApplicationName
			0x02, 0x08, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d,
			0x6e, 0x61, 0x6d, 0x65,
			// ApplicationType
			0x00, 0x00, 0x00, 0x00,
			// GatewayServerURI
			0x06, 0x00, 0x00, 0x00, 0x67, 0x77, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryProfileURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x66, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryURIs
			0x02, 0x00, 0x00, 0x00,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x31,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x32,
			// ServerCertificate
			0xff, 0xff, 0xff, 0xff,
			// MessageSecurityMode
			0x01, 0x00, 0x00, 0x00,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// UserIdentityTokens
			// ArraySize
			0x02, 0x00, 0x00, 0x00,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// TransportProfileURI
			0x09, 0x00, 0x00, 0x00, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x2d, 0x75, 0x72, 0x69,
			// SecurityLevel
			0x00,
		},
	},
}

func TestDecodeEndpointDescription(t *testing.T) {
	for _, c := range endpointDescriptionCases {
		got, err := DecodeEndpointDescription(c.serialized)
		if err != nil {
			t.Fatal(err)
		}

		if diff := cmp.Diff(got, c.structured); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}

func TestSerializeEndpointDescription(t *testing.T) {
	for _, c := range endpointDescriptionCases {
		got, err := c.structured.Serialize()
		if err != nil {
			t.Fatal(err)
		}

		if diff := cmp.Diff(got, c.serialized); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}

func TestEndpointDescriptionLen(t *testing.T) {
	for _, c := range endpointDescriptionCases {
		got := c.structured.Len()

		if diff := cmp.Diff(got, len(c.serialized)); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}

var endpointDescriptionArrayCases = []struct {
	description string
	structured  *EndpointDescriptionArray
	serialized  []byte
}{
	{
		"normal",
		NewEndpointDescriptionArray(
			[]*EndpointDescription{
				NewEndpointDescription(
					"ep-url",
					NewApplicationDescription(
						"app-uri", "prod-uri", "app-name", AppTypeServer,
						"gw-uri", "prof-uri", []string{"discov-uri-1", "discov-uri-2"},
					),
					[]byte{},
					1,
					"sec-uri",
					NewUserTokenPolicyArray(
						[]*UserTokenPolicy{
							NewUserTokenPolicy(
								"1", UserTokenAnonymous,
								"issued-token", "issuer-uri", "sec-uri",
							),
							NewUserTokenPolicy(
								"1", UserTokenAnonymous,
								"issued-token", "issuer-uri", "sec-uri",
							),
						},
					),
					"trans-uri",
					0,
				),
				NewEndpointDescription(
					"ep-url",
					NewApplicationDescription(
						"app-uri", "prod-uri", "app-name", AppTypeServer,
						"gw-uri", "prof-uri", []string{"discov-uri-1", "discov-uri-2"},
					),
					[]byte{},
					1,
					"sec-uri",
					NewUserTokenPolicyArray(
						[]*UserTokenPolicy{
							NewUserTokenPolicy(
								"1", UserTokenAnonymous,
								"issued-token", "issuer-uri", "sec-uri",
							),
							NewUserTokenPolicy(
								"1", UserTokenAnonymous,
								"issued-token", "issuer-uri", "sec-uri",
							),
						},
					),
					"trans-uri",
					0,
				),
			},
		),
		[]byte{
			// ArraySize
			0x02, 0x00, 0x00, 0x00,
			// EndpointURI
			0x06, 0x00, 0x00, 0x00, 0x65, 0x70, 0x2d, 0x75, 0x72, 0x6c,
			// Server (ApplicationDescription)
			// ApplicationURI
			0x07, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d, 0x75, 0x72, 0x69,
			// ProductURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x64, 0x2d, 0x75, 0x72, 0x69,
			// ApplicationName
			0x02, 0x08, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d,
			0x6e, 0x61, 0x6d, 0x65,
			// ApplicationType
			0x00, 0x00, 0x00, 0x00,
			// GatewayServerURI
			0x06, 0x00, 0x00, 0x00, 0x67, 0x77, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryProfileURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x66, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryURIs
			0x02, 0x00, 0x00, 0x00,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x31,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x32,
			// ServerCertificate
			0xff, 0xff, 0xff, 0xff,
			// MessageSecurityMode
			0x01, 0x00, 0x00, 0x00,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// UserIdentityTokens
			// ArraySize
			0x02, 0x00, 0x00, 0x00,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// TransportProfileURI
			0x09, 0x00, 0x00, 0x00, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x2d, 0x75, 0x72, 0x69,
			// SecurityLevel
			0x00,
			// EndpointURI
			0x06, 0x00, 0x00, 0x00, 0x65, 0x70, 0x2d, 0x75, 0x72, 0x6c,
			// Server (ApplicationDescription)
			// ApplicationURI
			0x07, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d, 0x75, 0x72, 0x69,
			// ProductURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x64, 0x2d, 0x75, 0x72, 0x69,
			// ApplicationName
			0x02, 0x08, 0x00, 0x00, 0x00, 0x61, 0x70, 0x70, 0x2d,
			0x6e, 0x61, 0x6d, 0x65,
			// ApplicationType
			0x00, 0x00, 0x00, 0x00,
			// GatewayServerURI
			0x06, 0x00, 0x00, 0x00, 0x67, 0x77, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryProfileURI
			0x08, 0x00, 0x00, 0x00, 0x70, 0x72, 0x6f, 0x66, 0x2d, 0x75, 0x72, 0x69,
			// DiscoveryURIs
			0x02, 0x00, 0x00, 0x00,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x31,
			0x0c, 0x00, 0x00, 0x00, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x2d, 0x75, 0x72, 0x69, 0x2d, 0x32,
			// ServerCertificate
			0xff, 0xff, 0xff, 0xff,
			// MessageSecurityMode
			0x01, 0x00, 0x00, 0x00,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// UserIdentityTokens
			// ArraySize
			0x02, 0x00, 0x00, 0x00,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// PolicyID
			0x01, 0x00, 0x00, 0x00, 0x31,
			// TokenType
			0x00, 0x00, 0x00, 0x00,
			// IssuedTokenType
			0x0c, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x64, 0x2d, 0x74, 0x6f, 0x6b, 0x65, 0x6e,
			// IssuerEndpointURI
			0x0a, 0x00, 0x00, 0x00, 0x69, 0x73, 0x73, 0x75, 0x65, 0x72, 0x2d, 0x75, 0x72, 0x69,
			// SecurityPolicyURI
			0x07, 0x00, 0x00, 0x00, 0x73, 0x65, 0x63, 0x2d, 0x75, 0x72, 0x69,
			// TransportProfileURI
			0x09, 0x00, 0x00, 0x00, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x2d, 0x75, 0x72, 0x69,
			// SecurityLevel
			0x00,
		},
	},
}

func TestDecodeEndpointDescriptionArray(t *testing.T) {
	for _, c := range endpointDescriptionArrayCases {
		got, err := DecodeEndpointDescriptionArray(c.serialized)
		if err != nil {
			t.Fatal(err)
		}

		if diff := cmp.Diff(got, c.structured); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}

func TestSerializeEndpointDescriptionArray(t *testing.T) {
	for _, c := range endpointDescriptionArrayCases {
		got, err := c.structured.Serialize()
		if err != nil {
			t.Fatal(err)
		}

		if diff := cmp.Diff(got, c.serialized); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}

func TestEndpointDescriptionArrayLen(t *testing.T) {
	for _, c := range endpointDescriptionArrayCases {
		got := c.structured.Len()

		if diff := cmp.Diff(got, len(c.serialized)); diff != "" {
			t.Errorf("%s failed\n%s", c.description, diff)
		}
	}
}
